<?xml version="1.0"?>
<dialects>
  <dialect type="POLYPHENY">

    <!-- NEW‑ORDER must grab warehouse, district and stock rows FOR UPDATE -->
    <procedure name="NewOrder">
      <statement name="selectWarehouseStmt">
        SELECT W_YTD
          FROM warehouse
         WHERE W_ID = ?
           FOR UPDATE
      </statement>
      <statement name="selectDistrictStmt">
        SELECT D_NEXT_O_ID
          FROM district
         WHERE D_W_ID = ?
           AND D_ID = ?
           FOR UPDATE
      </statement>
      <statement name="selectStockStmt">
        SELECT S_QUANTITY, S_YTD, S_ORDER_CNT, S_REMOTE_CNT
          FROM stock
         WHERE S_W_ID = ?
           AND S_I_ID = ?
           FOR UPDATE
      </statement>
    </procedure>

    <!-- PAYMENT touches warehouse, district and customer rows FOR UPDATE -->
    <procedure name="Payment">
      <statement name="selectWarehouseStmt">
        SELECT W_YTD
          FROM warehouse
         WHERE W_ID = ?
           FOR UPDATE
      </statement>
      <statement name="updateWarehouseStmt">
        UPDATE warehouse
           SET W_YTD = ?
         WHERE W_ID = ?
      </statement>
      <statement name="selectDistrictStmt">
        SELECT D_YTD
          FROM district
         WHERE D_W_ID = ?
           AND D_ID = ?
           FOR UPDATE
      </statement>
      <statement name="updateDistrictStmt">
        UPDATE district
           SET D_YTD = ?
         WHERE D_W_ID = ?
           AND D_ID = ?
      </statement>
      <statement name="selectCustomerStmt">
        SELECT C_BALANCE, C_YTD_PAYMENT, C_PAYMENT_CNT
          FROM customer
         WHERE C_W_ID = ?
           AND C_D_ID = ?
           AND C_ID = ?
           FOR UPDATE
      </statement>
      <statement name="updateCustomerStmt">
        UPDATE customer
           SET C_BALANCE     = ?,
               C_YTD_PAYMENT = ?,
               C_PAYMENT_CNT = ?
         WHERE C_W_ID = ?
           AND C_D_ID = ?
           AND C_ID   = ?
      </statement>
      <statement name="insertHistoryStmt">
        INSERT INTO history
          (H_C_ID, H_C_D_ID, H_C_W_ID, H_D_ID, H_W_ID, H_DATE, H_AMOUNT, H_DATA)
        VALUES (?,     ?,        ?,         ?,      ?,      ?,      ?,        ?)
      </statement>
    </procedure>

    <!-- ORDER‑STATUS just reads, no locks needed -->
    <procedure name="OrderStatus">
      <statement name="selectCustomerByIdStmt">
        SELECT C_BALANCE
          FROM customer
         WHERE C_W_ID = ?
           AND C_D_ID = ?
           AND C_ID   = ?
      </statement>
      <statement name="selectLastOrderStmt">
        SELECT O_ID, O_ENTRY_D, O_CARRIER_ID
          FROM oorder
         WHERE O_W_ID = ?
           AND O_D_ID = ?
           AND O_C_ID = ?
      ORDER BY O_ID DESC
         LIMIT 1
      </statement>
      <statement name="selectOrderLinesStmt">
        SELECT OL_I_ID, OL_SUPPLY_W_ID, OL_QUANTITY, OL_AMOUNT
          FROM order_line
         WHERE OL_W_ID = ?
           AND OL_D_ID = ?
           AND OL_O_ID = ?
      </statement>
    </procedure>

    <!-- DELIVERY steps through each district, deleting the oldest new_order -->
    <procedure name="Delivery">
      <statement name="selectNewOrderStmt">
        SELECT NO_O_ID
          FROM new_order
         WHERE NO_W_ID = ?
           AND NO_D_ID = ?
      ORDER BY NO_O_ID ASC
         LIMIT 1
           FOR UPDATE
      </statement>
      <statement name="deleteNewOrderStmt">
        DELETE
          FROM new_order
         WHERE NO_W_ID = ?
           AND NO_D_ID = ?
           AND NO_O_ID = ?
      </statement>
      <statement name="selectOrderStmt">
        SELECT O_C_ID
          FROM oorder
         WHERE O_W_ID      = ?
           AND O_D_ID      = ?
           AND O_ID        = ?
           FOR UPDATE
      </statement>
      <statement name="updateOrderStmt">
        UPDATE oorder
           SET O_CARRIER_ID = ?
         WHERE O_W_ID = ?
           AND O_D_ID = ?
           AND O_ID   = ?
      </statement>
      <statement name="updateOrderLineStmt">
        UPDATE order_line
           SET OL_DELIVERY_D = ?
         WHERE OL_W_ID = ?
           AND OL_D_ID = ?
           AND OL_O_ID = ?
      </statement>
      <statement name="updateCustomerBalanceStmt">
        UPDATE customer
           SET C_BALANCE     = C_BALANCE + ?,
               C_DELIVERY_CNT = C_DELIVERY_CNT + 1
         WHERE C_W_ID = ?
           AND C_D_ID = ?
           AND C_ID   = ?
      </statement>
      <statement name="insertDeliveryHistoryStmt">
        INSERT INTO history
          (H_C_ID, H_C_D_ID, H_C_W_ID, H_D_ID, H_W_ID, H_DATE, H_AMOUNT, H_DATA)
        VALUES (?,     ?,        ?,        ?,      ?,      ?,      ?,        ?)
      </statement>
    </procedure>

    <!-- STOCK‑LEVEL only needs to count (no locks) -->
    <procedure name="StockLevel">
      <statement name="selectDistrictNextOrderStmt">
        SELECT D_NEXT_O_ID
          FROM district
         WHERE D_W_ID = ?
           AND D_ID   = ?
      </statement>
      <statement name="selectStockCountStmt">
        SELECT COUNT(*)
          FROM stock
         WHERE S_W_ID    = ?
           AND S_I_ID   < ?
           AND S_QUANTITY < ?
      </statement>
    </procedure>

  </dialect>
</dialects>
